<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Marker Recognition</title>
    <script src="https://cdn.jsdelivr.net/gh/aframevr/aframe@1c2407b26c61958baa93967b5412487cd94b290b/dist/aframe-master.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        
        .ar-container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        
        .instructions {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px;
            border-radius: 10px;
            z-index: 1000;
            text-align: center;
        }
        
        .back-button {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1001;
            text-decoration: none;
        }
        
        .back-button:hover {
            background: #0056b3;
        }
        
        .camera-selector {
            position: absolute;
            top: 80px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px;
            border-radius: 10px;
            z-index: 1000;
            display: none;
        }
        
        .camera-selector select {
            width: 100%;
            padding: 8px;
            border-radius: 5px;
            border: none;
            background: white;
            color: black;
            margin-top: 10px;
        }
        
        .camera-toggle {
            position: absolute;
            top: 20px;
            left: 20px;
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1001;
        }
        
        .camera-toggle:hover {
            background: #218838;
        }
    </style>
</head>
<body>
    <div class="ar-container">
        <a href="/" class="back-button">â† æˆ»ã‚‹</a>
        <button class="camera-toggle" onclick="toggleCameraSelector()">ğŸ“· ã‚«ãƒ¡ãƒ©é¸æŠ</button>
        
        <div class="instructions">
            <h3>AR ãƒãƒ¼ã‚«ãƒ¼èªè­˜</h3>
            <p>ã‚«ãƒ¡ãƒ©ã‚’ãƒãƒ¼ã‚«ãƒ¼ã«å‘ã‘ã¦ãã ã•ã„</p>
            <p>ãƒãƒ¼ã‚«ãƒ¼ãŒèªè­˜ã•ã‚Œã‚‹ã¨ã€3Dã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
        </div>
        
        <div class="camera-selector" id="cameraSelector">
            <h4>ã‚«ãƒ¡ãƒ©ãƒ‡ãƒã‚¤ã‚¹ã‚’é¸æŠ</h4>
            <p style="font-size: 12px; margin: 5px 0; color: #ccc;">
                åˆå›ã¯ã‚«ãƒ¡ãƒ©ã®è¨±å¯ãŒå¿…è¦ã§ã™ã€‚è©³ç´°ãªãƒ‡ãƒã‚¤ã‚¹åã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã«ã€ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚
            </p>
            <select id="cameraSelect">
                <option value="">ã‚«ãƒ¡ãƒ©ã‚’æ¤œç´¢ä¸­...</option>
            </select>
            <button onclick="applyCameraSelection()" style="
                width: 100%;
                padding: 10px;
                margin-top: 10px;
                background: #007bff;
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
            ">ã‚«ãƒ¡ãƒ©ã‚’é©ç”¨</button>
            <div id="cameraDebugInfo" style="
                font-size: 10px;
                color: #ccc;
                margin-top: 5px;
                padding: 5px;
                background: rgba(0,0,0,0.3);
                border-radius: 3px;
                display: none;
            "></div>
            <button onclick="refreshCameraList()" style="
                width: 100%;
                padding: 8px;
                margin-top: 5px;
                background: #6c757d;
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                font-size: 12px;
            ">ã‚«ãƒ¡ãƒ©ä¸€è¦§ã‚’æ›´æ–°</button>
        </div>

        <!-- A-Frame AR Scene -->
        <a-scene
            vr-mode-ui="enabled: false;"
            renderer="logarithmicDepthBuffer: true;"
            embedded
            arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
            id="arScene">
            
            <!-- Hiroãƒãƒ¼ã‚«ãƒ¼ç”¨ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ -->
            <a-marker preset="hiro">
                <a-box position="0 0.5 0" material="color: red;" rotation="0 45 0"></a-box>
                <a-sphere position="1 1 0" material="color: blue;" radius="0.3"></a-sphere>
                <a-cylinder position="-1 1 0" material="color: green;" radius="0.3" height="1"></a-cylinder>
            </a-marker>

            <!-- Kanjiãƒãƒ¼ã‚«ãƒ¼ç”¨ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ -->
            <a-marker preset="kanji">
                <a-cone position="0 1 0" material="color: yellow;" radius-bottom="0.5" height="1"></a-cone>
                <a-torus position="0 2 0" material="color: purple;" radius="0.5" radius-tubular="0.1"></a-torus>
            </a-marker>

            <!-- ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ¼ã‚«ãƒ¼ç”¨ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ -->
            <a-marker id="custom-marker" type="pattern" url="./markers/pattern.patt">
                <a-text value="Pattern Marker" position="0 1 0" align="center" color="white"></a-text>
                <a-plane position="0 0 0" rotation="-90 0 0" width="2" height="2" color="orange"></a-plane>
            </a-marker>

            <!-- ã‚«ãƒ¡ãƒ©è¨­å®š -->
            <a-entity camera></a-entity>
        </a-scene>
    </div>

    <script>
        let availableCameras = [];
        let currentCameraId = null;

        // ã‚«ãƒ¡ãƒ©ãƒ‡ãƒã‚¤ã‚¹ã‚’å–å¾—ã™ã‚‹é–¢æ•°
        async function getCameraDevices() {
            try {
                // ã¾ãšä¸€æ™‚çš„ã«ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã‚’å–å¾—ã—ã¦ãƒ‡ãƒã‚¤ã‚¹åã‚’å–å¾—
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                
                // ã‚«ãƒ¡ãƒ©ã®è©³ç´°æƒ…å ±ã‚’å–å¾—
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                availableCameras = videoDevices;
                
                // ä¸€æ™‚çš„ãªã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åœæ­¢
                stream.getTracks().forEach(track => track.stop());
                
                const select = document.getElementById('cameraSelect');
                select.innerHTML = '';
                
                if (videoDevices.length === 0) {
                    select.innerHTML = '<option value="">ã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</option>';
                    return;
                }
                
                videoDevices.forEach((device, index) => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    
                    // ãƒ‡ãƒã‚¤ã‚¹åã‚’ã‚ˆã‚Šè©³ç´°ã«è¡¨ç¤º
                    let deviceName = device.label;
                    if (!deviceName || deviceName === '') {
                        // ãƒ‡ãƒã‚¤ã‚¹åãŒå–å¾—ã§ããªã„å ´åˆã€ã‚ˆã‚Šè©³ç´°ãªæƒ…å ±ã‚’è¡¨ç¤º
                        deviceName = `ã‚«ãƒ¡ãƒ© ${index + 1} (ID: ${device.deviceId.substring(0, 8)}...)`;
                    }
                    
                    option.textContent = deviceName;
                    select.appendChild(option);
                });
                
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æœ€åˆã®ã‚«ãƒ¡ãƒ©ã‚’é¸æŠ
                if (videoDevices.length > 0) {
                    select.value = videoDevices[0].deviceId;
                    currentCameraId = videoDevices[0].deviceId;
                }
                
            } catch (error) {
                console.error('ã‚«ãƒ¡ãƒ©ãƒ‡ãƒã‚¤ã‚¹ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                
                // ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚ŒãŸå ´åˆã€åŸºæœ¬çš„ãªæƒ…å ±ã®ã¿è¡¨ç¤º
                try {
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    const videoDevices = devices.filter(device => device.kind === 'videoinput');
                    
                    const select = document.getElementById('cameraSelect');
                    select.innerHTML = '';
                    
                    if (videoDevices.length === 0) {
                        select.innerHTML = '<option value="">ã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</option>';
                        return;
                    }
                    
                    videoDevices.forEach((device, index) => {
                        const option = document.createElement('option');
                        option.value = device.deviceId;
                        option.textContent = `ã‚«ãƒ¡ãƒ© ${index + 1} (è©³ç´°æƒ…å ±ã¯ã‚«ãƒ¡ãƒ©è¨±å¯å¾Œã«è¡¨ç¤º)`;
                        select.appendChild(option);
                    });
                    
                    if (videoDevices.length > 0) {
                        select.value = videoDevices[0].deviceId;
                        currentCameraId = videoDevices[0].deviceId;
                    }
                    
                } catch (fallbackError) {
                    console.error('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ã‚‚å¤±æ•—ã—ã¾ã—ãŸ:', fallbackError);
                    document.getElementById('cameraSelect').innerHTML = '<option value="">ã‚«ãƒ¡ãƒ©ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</option>';
                }
            }
        }

        // ã‚«ãƒ¡ãƒ©ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
        function toggleCameraSelector() {
            const selector = document.getElementById('cameraSelector');
            const debugInfo = document.getElementById('cameraDebugInfo');
            
            if (selector.style.display === 'none' || selector.style.display === '') {
                selector.style.display = 'block';
                debugInfo.style.display = 'block';
                
                // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’æ›´æ–°
                updateDebugInfo();
                
                if (availableCameras.length === 0) {
                    getCameraDevices();
                }
            } else {
                selector.style.display = 'none';
                debugInfo.style.display = 'none';
            }
        }

        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’æ›´æ–°
        function updateDebugInfo() {
            const debugInfo = document.getElementById('cameraDebugInfo');
            const scene = document.querySelector('a-scene');
            const arjs = scene.components.arjs;
            
            let debugText = `åˆ©ç”¨å¯èƒ½ã‚«ãƒ¡ãƒ©æ•°: ${availableCameras.length}<br>`;
            debugText += `ç¾åœ¨ã®ã‚«ãƒ¡ãƒ©ID: ${currentCameraId || 'æœªè¨­å®š'}<br>`;
            
            if (arjs && arjs.videoElement && arjs.videoElement.srcObject) {
                const track = arjs.videoElement.srcObject.getVideoTracks()[0];
                if (track) {
                    const settings = track.getSettings();
                    debugText += `AR.jsã‚«ãƒ¡ãƒ©ID: ${settings.deviceId || 'ä¸æ˜'}<br>`;
                    debugText += `è§£åƒåº¦: ${settings.width}x${settings.height}`;
                }
            }
            
            debugInfo.innerHTML = debugText;
        }

        // ã‚«ãƒ¡ãƒ©ä¸€è¦§ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        async function refreshCameraList() {
            const select = document.getElementById('cameraSelect');
            select.innerHTML = '<option value="">ã‚«ãƒ¡ãƒ©ã‚’å†æ¤œç´¢ä¸­...</option>';
            
            // åˆ©ç”¨å¯èƒ½ãªã‚«ãƒ¡ãƒ©ãƒªã‚¹ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
            availableCameras = [];
            
            // ã‚«ãƒ¡ãƒ©ãƒ‡ãƒã‚¤ã‚¹ã‚’å†å–å¾—
            await getCameraDevices();
        }

        // é¸æŠã•ã‚ŒãŸã‚«ãƒ¡ãƒ©ã‚’é©ç”¨
        async function applyCameraSelection() {
            const selectedCameraId = document.getElementById('cameraSelect').value;
            if (!selectedCameraId) {
                alert('ã‚«ãƒ¡ãƒ©ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            if (selectedCameraId === currentCameraId) {
                alert('åŒã˜ã‚«ãƒ¡ãƒ©ãŒæ—¢ã«é¸æŠã•ã‚Œã¦ã„ã¾ã™');
                return;
            }
            
            try {
                // é¸æŠã•ã‚ŒãŸã‚«ãƒ¡ãƒ©ã§ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’å–å¾—
                const constraints = {
                    video: {
                        deviceId: { exact: selectedCameraId }
                    }
                };
                
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                
                // AR.jsã®ã‚«ãƒ¡ãƒ©ã‚½ãƒ¼ã‚¹ã‚’æ›´æ–°
                const scene = document.querySelector('a-scene');
                const arjs = scene.components.arjs;
                
                if (arjs && arjs.data && arjs.data.sourceType === 'webcam') {
                    // æ—¢å­˜ã®ãƒ“ãƒ‡ã‚ªã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åœæ­¢
                    if (arjs.videoElement && arjs.videoElement.srcObject) {
                        const oldStream = arjs.videoElement.srcObject;
                        oldStream.getTracks().forEach(track => track.stop());
                    }
                    
                    // æ–°ã—ã„ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’è¨­å®š
                    arjs.videoElement.srcObject = stream;
                    
                    // AR.jsã‚’å†åˆæœŸåŒ–
                    arjs.play();
                }
                
                currentCameraId = selectedCameraId;
                
                // ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã‚’éè¡¨ç¤ºã«ã™ã‚‹
                document.getElementById('cameraSelector').style.display = 'none';
                
                console.log('ã‚«ãƒ¡ãƒ©ãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸ:', selectedCameraId);
                
            } catch (error) {
                console.error('ã‚«ãƒ¡ãƒ©ã®åˆ‡ã‚Šæ›¿ãˆã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                alert('ã‚«ãƒ¡ãƒ©ã®åˆ‡ã‚Šæ›¿ãˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // ãƒãƒ¼ã‚«ãƒ¼ãŒèªè­˜ã•ã‚ŒãŸæ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.addEventListener('DOMContentLoaded', function() {
            const scene = document.querySelector('a-scene');
            
            // ã‚«ãƒ¡ãƒ©ãƒ‡ãƒã‚¤ã‚¹ã‚’å–å¾—
            getCameraDevices();
            
            // AR.jsãŒå®Œå…¨ã«åˆæœŸåŒ–ã•ã‚Œã‚‹ã¾ã§å¾…æ©Ÿ
            scene.addEventListener('loaded', function() {
                console.log('AR.js scene loaded');
                
                // åˆæœŸã‚«ãƒ¡ãƒ©IDã‚’è¨­å®š
                const arjs = scene.components.arjs;
                if (arjs && arjs.videoElement && arjs.videoElement.srcObject) {
                    // ç¾åœ¨ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‹ã‚‰ãƒ‡ãƒã‚¤ã‚¹IDã‚’å–å¾—
                    const track = arjs.videoElement.srcObject.getVideoTracks()[0];
                    if (track) {
                        const settings = track.getSettings();
                        currentCameraId = settings.deviceId;
                        console.log('Initial camera ID:', currentCameraId);
                    }
                }
            });
            
            // Hiroãƒãƒ¼ã‚«ãƒ¼ãŒèªè­˜ã•ã‚ŒãŸæ™‚
            const hiroMarker = document.querySelector('a-marker[preset="hiro"]');
            hiroMarker.addEventListener('markerFound', function() {
                console.log('Hiro marker found!');
                // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
                const box = document.querySelector('a-marker[preset="hiro"] a-box');
                box.setAttribute('animation', 'property: rotation; to: 0 405 0; dur: 2000; easing: linear');
            });

            // Kanjiãƒãƒ¼ã‚«ãƒ¼ãŒèªè­˜ã•ã‚ŒãŸæ™‚
            const kanjiMarker = document.querySelector('a-marker[preset="kanji"]');
            kanjiMarker.addEventListener('markerFound', function() {
                console.log('Kanji marker found!');
                // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
                const cone = document.querySelector('a-marker[preset="kanji"] a-cone');
                cone.setAttribute('animation', 'property: scale; to: 1.5 1.5 1.5; dur: 1000; easing: easeInOut');
            });

            // ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ¼ã‚«ãƒ¼ãŒèªè­˜ã•ã‚ŒãŸæ™‚
            const customMarker = document.querySelector('#custom-marker');
            customMarker.addEventListener('markerFound', function() {
                console.log('Pattern marker found!');
                // ãƒ†ã‚­ã‚¹ãƒˆã«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
                const text = document.querySelector('#custom-marker a-text');
                text.setAttribute('animation', 'property: rotation; to: 0 360 0; dur: 3000; easing: linear');
            });
        });
    </script>
</body>
</html>

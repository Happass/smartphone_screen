<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Marker Recognition</title>
    <script src="https://cdn.jsdelivr.net/gh/aframevr/aframe@1c2407b26c61958baa93967b5412487cd94b290b/dist/aframe-master.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        
        .ar-container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        
        .instructions {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px;
            border-radius: 10px;
            z-index: 1000;
            text-align: center;
        }
        
        .back-button {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1001;
            text-decoration: none;
        }
        
        .back-button:hover {
            background: #0056b3;
        }
        
        .camera-selector {
            position: absolute;
            top: 80px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px;
            border-radius: 10px;
            z-index: 1000;
            display: none;
        }
        
        .camera-selector select {
            width: 100%;
            padding: 8px;
            border-radius: 5px;
            border: none;
            background: white;
            color: black;
            margin-top: 10px;
        }
        
        .camera-toggle {
            position: absolute;
            top: 20px;
            left: 20px;
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1001;
        }
        
        .camera-toggle:hover {
            background: #218838;
        }
    </style>
</head>
<body>
    <div class="ar-container">
        <a href="/" class="back-button">← 戻る</a>
        <button class="camera-toggle" onclick="toggleCameraSelector()">📷 カメラ選択</button>
        
        <div class="instructions">
            <h3>AR マーカー認識</h3>
            <p>カメラをマーカーに向けてください</p>
            <p>マーカーが認識されると、3Dオブジェクトが表示されます</p>
        </div>
        
        <div class="camera-selector" id="cameraSelector">
            <h4>カメラデバイスを選択</h4>
            <p style="font-size: 12px; margin: 5px 0; color: #ccc;">
                初回はカメラの許可が必要です。詳細なデバイス名を表示するために、カメラアクセスを許可してください。
            </p>
            <select id="cameraSelect">
                <option value="">カメラを検索中...</option>
            </select>
            <button onclick="applyCameraSelection()" style="
                width: 100%;
                padding: 10px;
                margin-top: 10px;
                background: #007bff;
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
            ">カメラを適用</button>
            <div id="cameraDebugInfo" style="
                font-size: 10px;
                color: #ccc;
                margin-top: 5px;
                padding: 5px;
                background: rgba(0,0,0,0.3);
                border-radius: 3px;
                display: none;
            "></div>
            <button onclick="refreshCameraList()" style="
                width: 100%;
                padding: 8px;
                margin-top: 5px;
                background: #6c757d;
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                font-size: 12px;
            ">カメラ一覧を更新</button>
        </div>

        <!-- A-Frame AR Scene -->
        <a-scene
            vr-mode-ui="enabled: false;"
            renderer="logarithmicDepthBuffer: true;"
            embedded
            arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
            id="arScene">
            
            <!-- Hiroマーカー用のオブジェクト -->
            <a-marker preset="hiro">
                <a-box position="0 0.5 0" material="color: red;" rotation="0 45 0"></a-box>
                <a-sphere position="1 1 0" material="color: blue;" radius="0.3"></a-sphere>
                <a-cylinder position="-1 1 0" material="color: green;" radius="0.3" height="1"></a-cylinder>
            </a-marker>

            <!-- Kanjiマーカー用のオブジェクト -->
            <a-marker preset="kanji">
                <a-cone position="0 1 0" material="color: yellow;" radius-bottom="0.5" height="1"></a-cone>
                <a-torus position="0 2 0" material="color: purple;" radius="0.5" radius-tubular="0.1"></a-torus>
            </a-marker>

            <!-- カスタムマーカー用のオブジェクト -->
            <a-marker id="custom-marker" type="pattern" url="./markers/pattern.patt">
                <a-text value="Pattern Marker" position="0 1 0" align="center" color="white"></a-text>
                <a-plane position="0 0 0" rotation="-90 0 0" width="2" height="2" color="orange"></a-plane>
            </a-marker>

            <!-- カメラ設定 -->
            <a-entity camera></a-entity>
        </a-scene>
    </div>

    <script>
        let availableCameras = [];
        let currentCameraId = null;

        // カメラデバイスを取得する関数
        async function getCameraDevices() {
            try {
                // まず一時的にカメラアクセスを取得してデバイス名を取得
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                
                // カメラの詳細情報を取得
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                availableCameras = videoDevices;
                
                // 一時的なストリームを停止
                stream.getTracks().forEach(track => track.stop());
                
                const select = document.getElementById('cameraSelect');
                select.innerHTML = '';
                
                if (videoDevices.length === 0) {
                    select.innerHTML = '<option value="">カメラが見つかりません</option>';
                    return;
                }
                
                videoDevices.forEach((device, index) => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    
                    // デバイス名をより詳細に表示
                    let deviceName = device.label;
                    if (!deviceName || deviceName === '') {
                        // デバイス名が取得できない場合、より詳細な情報を表示
                        deviceName = `カメラ ${index + 1} (ID: ${device.deviceId.substring(0, 8)}...)`;
                    }
                    
                    option.textContent = deviceName;
                    select.appendChild(option);
                });
                
                // デフォルトで最初のカメラを選択
                if (videoDevices.length > 0) {
                    select.value = videoDevices[0].deviceId;
                    currentCameraId = videoDevices[0].deviceId;
                }
                
            } catch (error) {
                console.error('カメラデバイスの取得に失敗しました:', error);
                
                // カメラアクセスが拒否された場合、基本的な情報のみ表示
                try {
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    const videoDevices = devices.filter(device => device.kind === 'videoinput');
                    
                    const select = document.getElementById('cameraSelect');
                    select.innerHTML = '';
                    
                    if (videoDevices.length === 0) {
                        select.innerHTML = '<option value="">カメラが見つかりません</option>';
                        return;
                    }
                    
                    videoDevices.forEach((device, index) => {
                        const option = document.createElement('option');
                        option.value = device.deviceId;
                        option.textContent = `カメラ ${index + 1} (詳細情報はカメラ許可後に表示)`;
                        select.appendChild(option);
                    });
                    
                    if (videoDevices.length > 0) {
                        select.value = videoDevices[0].deviceId;
                        currentCameraId = videoDevices[0].deviceId;
                    }
                    
                } catch (fallbackError) {
                    console.error('フォールバック処理も失敗しました:', fallbackError);
                    document.getElementById('cameraSelect').innerHTML = '<option value="">カメラの取得に失敗しました</option>';
                }
            }
        }

        // カメラセレクターの表示/非表示を切り替え
        function toggleCameraSelector() {
            const selector = document.getElementById('cameraSelector');
            const debugInfo = document.getElementById('cameraDebugInfo');
            
            if (selector.style.display === 'none' || selector.style.display === '') {
                selector.style.display = 'block';
                debugInfo.style.display = 'block';
                
                // デバッグ情報を更新
                updateDebugInfo();
                
                if (availableCameras.length === 0) {
                    getCameraDevices();
                }
            } else {
                selector.style.display = 'none';
                debugInfo.style.display = 'none';
            }
        }

        // デバッグ情報を更新
        function updateDebugInfo() {
            const debugInfo = document.getElementById('cameraDebugInfo');
            const scene = document.querySelector('a-scene');
            const arjs = scene.components.arjs;
            
            let debugText = `利用可能カメラ数: ${availableCameras.length}<br>`;
            debugText += `現在のカメラID: ${currentCameraId || '未設定'}<br>`;
            
            if (arjs && arjs.videoElement && arjs.videoElement.srcObject) {
                const track = arjs.videoElement.srcObject.getVideoTracks()[0];
                if (track) {
                    const settings = track.getSettings();
                    debugText += `AR.jsカメラID: ${settings.deviceId || '不明'}<br>`;
                    debugText += `解像度: ${settings.width}x${settings.height}`;
                }
            }
            
            debugInfo.innerHTML = debugText;
        }

        // カメラ一覧を更新する関数
        async function refreshCameraList() {
            const select = document.getElementById('cameraSelect');
            select.innerHTML = '<option value="">カメラを再検索中...</option>';
            
            // 利用可能なカメラリストをリセット
            availableCameras = [];
            
            // カメラデバイスを再取得
            await getCameraDevices();
        }

        // 選択されたカメラを適用
        async function applyCameraSelection() {
            const selectedCameraId = document.getElementById('cameraSelect').value;
            if (!selectedCameraId) {
                alert('カメラを選択してください');
                return;
            }
            
            if (selectedCameraId === currentCameraId) {
                alert('同じカメラが既に選択されています');
                return;
            }
            
            try {
                // 選択されたカメラでストリームを取得
                const constraints = {
                    video: {
                        deviceId: { exact: selectedCameraId }
                    }
                };
                
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                
                // AR.jsのカメラソースを更新
                const scene = document.querySelector('a-scene');
                const arjs = scene.components.arjs;
                
                if (arjs && arjs.data && arjs.data.sourceType === 'webcam') {
                    // 既存のビデオストリームを停止
                    if (arjs.videoElement && arjs.videoElement.srcObject) {
                        const oldStream = arjs.videoElement.srcObject;
                        oldStream.getTracks().forEach(track => track.stop());
                    }
                    
                    // 新しいストリームを設定
                    arjs.videoElement.srcObject = stream;
                    
                    // AR.jsを再初期化
                    arjs.play();
                }
                
                currentCameraId = selectedCameraId;
                
                // セレクターを非表示にする
                document.getElementById('cameraSelector').style.display = 'none';
                
                console.log('カメラが変更されました:', selectedCameraId);
                
            } catch (error) {
                console.error('カメラの切り替えに失敗しました:', error);
                alert('カメラの切り替えに失敗しました: ' + error.message);
            }
        }

        // マーカーが認識された時のイベントリスナー
        document.addEventListener('DOMContentLoaded', function() {
            const scene = document.querySelector('a-scene');
            
            // カメラデバイスを取得
            getCameraDevices();
            
            // AR.jsが完全に初期化されるまで待機
            scene.addEventListener('loaded', function() {
                console.log('AR.js scene loaded');
                
                // 初期カメラIDを設定
                const arjs = scene.components.arjs;
                if (arjs && arjs.videoElement && arjs.videoElement.srcObject) {
                    // 現在のストリームからデバイスIDを取得
                    const track = arjs.videoElement.srcObject.getVideoTracks()[0];
                    if (track) {
                        const settings = track.getSettings();
                        currentCameraId = settings.deviceId;
                        console.log('Initial camera ID:', currentCameraId);
                    }
                }
            });
            
            // Hiroマーカーが認識された時
            const hiroMarker = document.querySelector('a-marker[preset="hiro"]');
            hiroMarker.addEventListener('markerFound', function() {
                console.log('Hiro marker found!');
                // オブジェクトにアニメーションを追加
                const box = document.querySelector('a-marker[preset="hiro"] a-box');
                box.setAttribute('animation', 'property: rotation; to: 0 405 0; dur: 2000; easing: linear');
            });

            // Kanjiマーカーが認識された時
            const kanjiMarker = document.querySelector('a-marker[preset="kanji"]');
            kanjiMarker.addEventListener('markerFound', function() {
                console.log('Kanji marker found!');
                // オブジェクトにアニメーションを追加
                const cone = document.querySelector('a-marker[preset="kanji"] a-cone');
                cone.setAttribute('animation', 'property: scale; to: 1.5 1.5 1.5; dur: 1000; easing: easeInOut');
            });

            // カスタムマーカーが認識された時
            const customMarker = document.querySelector('#custom-marker');
            customMarker.addEventListener('markerFound', function() {
                console.log('Pattern marker found!');
                // テキストにアニメーションを追加
                const text = document.querySelector('#custom-marker a-text');
                text.setAttribute('animation', 'property: rotation; to: 0 360 0; dur: 3000; easing: linear');
            });
        });
    </script>
</body>
</html>
